<style>
    .fontSize12{
        font-size:12px;
        line-height: 12px;
        height: 12px;
    }
    .fontSize14{
        font-size:14px;
        line-height: 14px!important;
        height: 14px!important;
    }
    .fontSize18{
        font-size:18px;
        line-height: 18px!important;
        height: 18px!important;
    }
    .fontSize24{
        font-size:24px;
        line-height: 24px!important;
        height: 24px!important;
    }
    .fontSize32{
        font-size:32px;
        line-height: 32px!important;
        height: 32px!important;
    }
    .fontSize48{
        font-size:48px;
        line-height: 48px!important;
        height: 48px!important;
    }
    .htItalic{
        font-style: italic;
    }
    .htBold{
        font-weight: bold;
    }
    .htUnderline{
        text-decoration:underline;
        text-underline: black;
    }
    .material-icons {
        font-size: 18px;
        display: block;
        margin-top: -2px;
    }
</style>
<link rel="stylesheet" href="css/page/sheet.css">
<div id="reportTemp" class="gui-div">
    <table class="toolbar-table" data-options="id: 'reportTempTable',herf:'report/gridset/query'">
    </table>
    <div id="reportTempTable-toolbar" class="gui-toolbar" data-options="grid:{type:'datagrid',id:'reportTempTable'}">
        <a class="toolbar-reload toolbar"  href="javascript:void(0)"></a>
        <a class="toolbar-add toolbar" href="javascript:void(0)"></a>
        <a class="toolbar-edit toolbar" href="javascript:void(0)"></a>
        <a class="toolbar-delete toolbar" href="javascript:void(0)"></a>

        <!-- <a class="toolbar-design" href="javascript:void(0)">报表设计</a> -->
        <a class="toolbar-design-v2" href="javascript:void(0)">报表设计</a>

       <!-- <a class="toolbar-design-new" href="javascript:void(0)">报表设计(新)</a>-->
        <a class="toolbar-publish" href="javascript:void(0)">功能发布</a>
        <a class="toolbar-unpublish" href="javascript:void(0)">取消发布</a>

        


        <a class="btn btn-primary serach toolbar-search"></a>
        <div class="bdsug" style="height: auto;">
            <form action="" class="query-criteria">
                <ul><li class="bdsug-store bdsug-overflow">
                <span style="margin: 10px">
                        <label >报表编码：</label> <input type="text" name="bbbm" data-toggle="gui-textbox" class="gui-textbox">
                    </span>
                    <span style="margin: 10px">
                        <label >报表名称：</label> <input type="text" name="bbmc" data-toggle="gui-textbox" class="gui-textbox">
                    </span>
                </li></ul>
            </form>
        </div>
    </div>
</div>
<script>



    function layerClose(index){
        layer.close(index);
    }

$(function () {
    $('#reportTemp .toolbar-design-new').iMenubutton({
        onClick: function () {
            var record_data = $('#reportTemp').find('.toolbar-table').datagrid('getSelected') || {};
            var record={};
            var table=null;
            var $container = $('<div style="position:relative"/>');
            $container.iDialog({
                title: '报表设计 -- ' +  record["bbmc"],
                maximized: 1,
                width: $(document).width(),
                height:$(document).height(),
                buttons: [{
                    text: '确认',
                    iconCls: 'fa fa-save',
                    btnCls: 'gui-btn-save',
                    handler: function () {

                    }
                },{text:'取消', iconCls: "fa fa-close", btnCls: "gui-btn-danger", handler:function () {$container.iDialog('close');}}],
                onOpen:function () {
                    var config= {
                        contextmenu: {
                            copy: "Copy",
                            cut: "Cut",
                            paste: "Paste",
                            insertRow: "Insert row",
                        },}
                   table= x.spreadsheet('#xss-demo',config);

                    table.loadData(
                        {}
                    ).change(function (radata) {
                        console.log(JSON.stringify(radata))
                    });
                },
                onDestroy:function(){
                },
                onClose: function () {
                    $(this).form("clear");
                    $(this).iDialog('destroy');
                }
            });
            var target='<div id="xss-demo"></div>';
            $container.html('').append(target);
            $container.iDialog('open');

        },
        text: '报表设计(新)',
        iconCls: 'fa fa-chain'
    });
    $('#reportTemp .toolbar-design').iMenubutton({
        onClick: function () {
            var record_data = $('#reportTemp').find('.toolbar-table').datagrid('getSelected') || {};
            var record={};
            if ( record_data==null || record_data === undefined ) {$.messager.alert('提示','请选择一条记录');return false;}
            HTTP.post("report/reporttemp/get",{id:record_data["id"]},function (result) {
                if(result["success"]&&result['data']["records"]){
                    record=result['data']["records"]
                }
            });

            var hideColumns=[],hideRows=[],hideCol=[],hideRow=[];
            var $container = $('<div style="position:relative"/>');
            $container.iDialog({
                title: '报表设计 -- ' +  record["bbmc"],
                maximized: 1,
                width: $(document).width(),
                height:$(document).height(),
                buttons: [{
                    text: '确认',
                    iconCls: 'fa fa-save',
                    btnCls: 'gui-btn-save',
                    handler: function () {
                        // div id:  handsontable

                        // TODO excel json data
                        function sumbitData(table) {
                            var config ={
                                rowNum:table.getRowHeader().length, colNum:table.getColHeader().length
                            };
                            var mergeCells=[],jsonData=[],cell=[],colWidth=[],rowHeight=[];
                            for(var i=0;i<config.rowNum;i++){
                                for(var j=0;j<config.colNum;j++){
                                    var cellPro=table.getCellMeta(i,j);
                                    var cellTarget=$(table.getCell(i,j));
                                    var item={
                                        row:cellPro.row,col:cellPro.col,
                                    };
                                    if(cellPro.className||cellPro.format){
                                        if(cellPro.className){
                                            $.extend(item,{ className:cellPro.className});
                                        }
                                        if(cellPro.format){
                                            $.extend(item,{format:cellPro.format});
                                        }
                                        cell.push(item);
                                    }
                                }
                                rowHeight.push(table.getRowHeight(i));
                            }
                            for(var m=0;m<config.colNum;m++){
                                colWidth.push(table.getColWidth(m))
                            }
                            mergeCells=hot.getPlugin('MergeCells').mergedCellsCollection.mergedCells;
                            var customBordersPlugin = table.getPlugin('customBorders');
                            return {
                                data:table.getData(),
                                customBorders:JSON.stringify(customBordersPlugin.getBorders()),
                                mergeCells:mergeCells,
                                cell:cell,
                                rows:hideRows,
                                cols:hideColumns,
                                colWidths:colWidth,
                                rowHeights:rowHeight
                            };
                        }

                        var json = sumbitData(hot);
                        HTTP.post('report/reporttemp/update/' + record["bbbm"], json, function (result) {
                            console.log(result.data);
                            if ( result.success ){
                                alert('报表模板[' + record["bbmc"] + ']更新成功');
                            } else {
                                alert(result.message || ('报表模板[' + record["bbmc"] + ']更新失败'));
                            }
                        });
                    }
                },{text:'取消', iconCls: "fa fa-close", btnCls: "gui-btn-danger", handler:function () {$container.iDialog('close');}}],
                onOpen:function () {

                    $(this).find('header input[name="cell"]').iTextbox({width:70});
                    /*expression*/
                    /*$(hot.rootElement).width()-680*/
                    $(this).find('header input[name="formula"]').iTextbox({width:$(hot.rootElement).width()-1200,onChange:function (event) {
                            var selectRange = hot.getSelected();
                            hot.setDataAtCell(selectRange[0][0],selectRange[0][1],$(this).val());
                        }});
                    $(this).find('.add-formula').unbind().bind('click',function () {
                        Appent.choose({
                            title:"数据点",
                            columns: [
                                {title: "ID", index: 10, field: "id", width: 160, halign:'center', align: 'left',  hidden: true },
                                {title: "参数编码", index: 20, field: "csbm", width: 160, halign:'center', align: 'left',  hidden: false },
                                {title: "参数名称", index: 30, field: "csmc", width: 160, halign:'center', align: 'left',  hidden: false },
                                {title: "参数类型", index: 40, field: "cslx", width: 160, halign:'center', align: 'left',  hidden: false ,
                                    formatter:function (value) {
                                        return {S: 'SQL语句'}[value] || value;
                                    }
                                },
                                {title: "参数分组", index: 10, field: "csfz", width: 160, halign:'center', align: 'left',  hidden: false },
                                {title: "参数选项", index: 60, field: "csxx", width: 160, halign:'center', align: 'left',  hidden: false },
                                {title: "参数说明", index: 65, field: "cssm", width: 160, halign:'center', align: 'left',  hidden: false },
                                {title: "停用标识", index: 70, field: "tybz", width: 160, halign:'center', align: 'left',  hidden: false },
                                {title: "停用日期", index: 80, field: "tyrq", width: 160, halign:'center', align: 'center',  hidden: false , formatter:function (value) {
                                        if ( value==undefined || value =='' ){
                                            return "";
                                        }
                                        var date = new Date(parseInt(value));
                                        if ( isNaN(date) ){
                                            return ""
                                        }
                                        return date.Format("yyyy-MM-dd");
                                    }
                                },
                                {title: "备注", index: 90, field: "bz", width: 160, halign:'center', align: 'left',  hidden: false },
                                {title: "系统版本", index: 100, field: "sysversion", width: 160, halign:'center', align: 'left',  hidden: false },
                                {title: "维护人编码", index: 110, field: "whrid", width: 160, halign:'center', align: 'left',  hidden: true },
                                {title: "维护人", index: 120, field: "whr", width: 160, halign:'center', align: 'left',  hidden: false },
                                {title: "维护时间", index: 130, field: "whsj", width: 160, halign:'center', align: 'center',  hidden: false , formatter:function (value) {
                                        if ( value==undefined || value =='' ){
                                            return "";
                                        }
                                        var date = new Date(parseInt(value));
                                        if ( isNaN(date) ){
                                            return ""
                                        }
                                        return date.Format("yyyy-MM-dd hh:mm:ss");
                                    }
                                },
                                {title: "创建人编码", index: 140, field: "cjrid", width: 160, halign:'center', align: 'left',  hidden: true },
                                {title: "创建人", index: 150, field: "cjr", width: 160, halign:'center', align: 'left',  hidden: false },
                                {title: "创建时间", index: 160, field: "cjsj", width: 160, halign:'center', align: 'center',  hidden: false , formatter:function (value) {
                                        if ( value==undefined || value =='' ){
                                            return "";
                                        }
                                        var date = new Date(parseInt(value));
                                        if ( isNaN(date) ){
                                            return ""
                                        }
                                        return date.Format("yyyy-MM-dd hh:mm:ss");
                                    }
                                }
                            ],
                            url: "report/reportparam/query",parmas:{}
                        }, function (row) {

                            console.log(row);
                            var value = row["csbm"];

                            if(row){
                                var selectRange = hot.getSelected();
                                hot.setDataAtCell(selectRange[0][0],selectRange[0][1], value);
                                $container.find('header input[textboxname="formula"]').textbox('setValue', value)
                            }
                        });
                    });
                    $container.unbind().bind('input propertychange','.handsontableInput',function(event){
                        $(this).find('header input[textboxname="formula"]').textbox('setValue',$(event.target).val())
                    });
                    /*btn-grounp*/
                    ComboboBox.init($(this).find('input[name="border_type"]'),{data:[{value:'0',text:"外侧框线",selected:true},
                            {value:'1',text:"下框线"},{value:'2',text:"上框线"},{value:'3',text:"左框线"},{value:'4',text:"右框线"},
                            {value:'5',text:"所有框线"},{value:'6',text:'无'}]});
                    ComboboBox.init($(this).find('input[name="font_size"]'),{editable:0,data:[{value:'fontSize12',text:"12",selected:true},
                            {value:'fontSize14',text:"14",},{value:'fontSize18',text:"18"},
                            {value:'fontSize24',text:"24",},{value:'fontSize32',text:"32"},
                            {value:'fontSize48',text:"48",}],onSelected:function (value) {
                            if(hot.getSelected()){
                                var  selectRangeArr = []; // 所选区域所有单元格数组
                                selectRange = hot.getSelected(); // 获取所选区域范围
                                console.log(selectRange);
                                var rangeRowArr = []; // 所选区域行数组
                                var rangeColArr = []; // 所选区域列数组
                                for( var i=selectRange[0][0];i<selectRange[0][2]+1;i++ ){
                                    rangeRowArr.push(i);
                                }
                                for( var i=selectRange[0][1];i<selectRange[0][3]+1;i++ ){
                                    rangeColArr.push(i);
                                }
                                for( var i=0;i<rangeRowArr.length;i++ ){
                                    for( var n=0;n<rangeColArr.length;n++ ){
                                        var selectRangeCell = { row:rangeRowArr[i],col:rangeColArr[n] };
                                        selectRangeArr.push(selectRangeCell);
                                    }
                                }
                                for( var m=0;m<selectRangeArr.length;m++ ){
                                    var rangeCell = hot.getCell(selectRangeArr[m].row, selectRangeArr[m].col);
                                    $(rangeCell).removeClass("fontSize12");
                                    $(rangeCell).removeClass("fontSize14");
                                    $(rangeCell).removeClass("fontSize24");
                                    $(rangeCell).removeClass("fontSize32");
                                    $(rangeCell).removeClass("fontSize48");
                                    var  StyleClassName = value.value;
                                    var setRangeCellClass = function(){
                                        $(rangeCell).toggleClass(StyleClassName);
                                        var cellClass = $(rangeCell)[0].className;
                                        hot.setCellMeta(selectRangeArr[m].row, selectRangeArr[m].col,"className",cellClass);
                                        hot.setCellMeta(selectRangeArr[m].row, selectRangeArr[m].col,"fontSize", StyleClassName);
                                    };
                                    setRangeCellClass();

                                }
                            }

                        }});

                    hot.render();

                },
                onDestroy:function(){
                    hot.destroy();
                },
                onClose: function () {
                    $(this).form("clear");
                    $(this).iDialog('destroy');
                }
            });
            var target='<div><header style="background-color: #e2e2e2;height: 36px;padding-top: 2px"><input type="text" name="cell">' +
                '<a class="add-formula l-btn l-btn-small l-btn-plain" href="javascript:void(0)" style="height: 28px;background-color: white;margin-left: 10px">' +
                '<span class="l-btn-left l-btn-icon-left" style="margin-top: 5px;"><span class="l-btn-text" style="margin: -4px 4px 0 24px;">fx</span></span></a>' +
                '<span style="margin-left: 4px" ><input type="text" name="formula" style=""></span>' +
                '<button type="button" class="btn btn-default btn-line" style="height: 32px">列设置</button>'+
                '<button type="button" class="btn btn-default btn-row" style="height: 32px">行设置</button>'+
                '<div class="btn-group-border" style="display: inline-block">' +
                '<label for="border_type"><input type="text" name="border_type" id="border_type"></label><button type="button" class="btn btn-default" style="height: 32px">边框</button>' +
                '<input type="text" name="font_size">' +
                '</div><div class="btn-group fontStyle" style="display: inline-block">\n' +
                '                    <button type="button" class="btn btn-default "><i class="material-icons">format_bold</i></button>\n' +
                '                    <button type="button" class="btn btn-default "><i class="material-icons">format_italic</i></button>\n' +
                '                    <button type="button" class="btn btn-default "><i class="material-icons">format_underline</i></button>\n' +
                '                </div>\n' +
                '                <div class="btn-group alignStyle" style="display: inline-block">\n' +
                '                    <button type="button" class="btn btn-default "><i class="material-icons">format_align_left</i></button>\n' +
                '                    <button type="button" class="btn btn-default "><i class="material-icons">format_align_center</i></button>\n' +
                '                    <button type="button" class="btn btn-default "><i class="material-icons">format_align_right</i></button>\n' +
                '                    <button type="button" class="btn btn-default "><i class="material-icons">format_align_justify</i></button>\n' +
                '                </div>' +
                '</header><div  id="handsontable" style=""></div></div>';
            $container.html('').append(target);
            var _config= {
                data: null,
                mergeCells: [],
                customBorders:[],
                cell:[],
                rows:[],
                cols:[],
                colWidths:[],
                rowHeights:[]
            };
            var startCols=parseInt(document.body.clientWidth/50-1);
            var startRows=parseInt(document.body.clientHeight-130/24);
            if(record["bbnr"]){
              _config = JSON.parse(record["bbnr"]);
            }
            var borders=[];
            if(_config["customBorders"]&&_config["customBorders"].length>0){
            	borders=JSON.parse(_config["customBorders"])
            }
            if(_config["cols"]){
                hideColumns=_config["cols"];
                hideCol=[];
                $.each(_config["cols"],function (i,ie) {
                    hideCol.push(ie.col);
                })
            }
            if(_config["rows"]){
                hideRows=_config["rows"];
                hideRow=[];
                $.each(_config["rows"],function (i,ie) {
                    hideRow.push(ie.row);
                })
            }
            var cellMenu={
                key: "cell", name:"设置单元格格式", callback: function () {
                    var selectRange = hot.getSelected();
                    var value=hot.getDataAtCell(selectRange[0][0],selectRange[0][1]);
                    var config=hot.getCellMeta(selectRange[0][0],selectRange[0][1]).format;
                    cell(value,config||undefined,function (data) {
                        var  selectRangeArr = [],rangeRowArr = [],rangeColArr = [];
                        for( var i=selectRange[0][0];i<selectRange[0][2]+1;i++ ){
                            rangeRowArr.push(i);
                        }
                        for( var i=selectRange[0][1];i<selectRange[0][3]+1;i++ ){
                            rangeColArr.push(i);
                        }
                        for( var i=0;i<rangeRowArr.length;i++ ){
                            for( var n=0;n<rangeColArr.length;n++ ){
                                var selectRangeCell = { row:rangeRowArr[i],col:rangeColArr[n] };
                                selectRangeArr.push(selectRangeCell);
                            }
                        }
                        for( var m=0;m<selectRangeArr.length;m++ ){
                            hot.setCellMeta(selectRangeArr[m].row,selectRangeArr[m].col,'format',data);
                        }
                        console.log(JSON.stringify(data))
                    });
                }, disabled: function () {
                }, hidden: false
            };
            var menu=['row_above','row_below','col_left','col_right','remove_row','remove_col','undo','redo','make_read_only',
                        'alignment','copy','cut','borders','mergeCells'];
            menu.push(cellMenu);
            var hot= new Handsontable(document.getElementById('handsontable'), {
                data: _config["data"],
                startCols: startCols,
                startRows: startRows,
                colWidths:_config["colWidths"],
                rowHeights:_config["rowHeights"],
                rowHeaders: true,
                colHeaders: true,
                licenseKey: 'non-commercial-and-evaluation',
                manualRowResize : true,
                manualColumnResize : true,
                manualColumnMove : true,
                manualRowMove : true,
                outsideClickDeselects: false,
                /*     filters: true,*/
                dropdownMenu: true,
                language:'zh-CN',
               /* contextMenu: true,*/
                contextMenu:menu,
                mergeCells:_config["mergeCells"],
                cell:_config["cell"],
                customBorder:true,
                customBorders:borders,
                afterOnCellMouseDown:function (event,coords,TD) {
                    var getSelectedRange=hot.getColHeader(coords.col)+hot.getRowHeader(coords.row);
                    $container.find('header input[textboxname="cell"]').data('col',coords.col);
                    $container.find('header input[textboxname="cell"]').data('row',coords.row);
                    $container.find('header input[textboxname="cell"]').textbox({value:getSelectedRange});
                    $container.find('header input[textboxname="formula"]').textbox('setValue',$(event.target).text());
                    $container.find('input[textboxname="font_size"]').combobox("setValue",hot.getCellMeta(coords.row,coords.col).fontSize||"fontSize12");
                }
            });

            var button1 = document.getElementById('export-file');
            $container.iDialog('open');
            //setborder
            var customBordersPlugin = hot.getPlugin('customBorders');
            // 修改单元格样式
            $(".btn-group-border .btn").click(function(e) {
                var _index = $(this).index();
                var range=hot.getSelectedRange();
                var x1=range[0].from.row,x2=range[0].from.col,y1=range[0].to.row,y2=range[0].to.col;
                var value= parseInt($container.find('header input[name="border_type"]').val());
                switch (value) {
                    case 0:alloutDrawBroders();break;
                    case 1: customBordersPlugin.setBorders([[y1,x2,y1,y2]], {bottom:{width: 1, color: 'black'}});break;
                    case 2: customBordersPlugin.setBorders([[x1,x2,x1,y2]], {top:{width: 1, color: 'black'}});break;
                    case 3:customBordersPlugin.setBorders([[x1,x2,y1,x2]], {left:{width: 1, color: 'black'}});break;
                    case 4: customBordersPlugin.setBorders([[x1,y2,y1,y2]], {right:{width: 1, color: 'black'}});break;
                    case 5:customBordersPlugin.setBorders([[x1,x2,y1,y2]], {right:{width: 1, color: 'black',hiden:false},left:{width: 1, color: 'black',hiden:false},top:{width: 1, color: 'black',hiden:false},bottom:{width: 1, color: 'black',hiden:false}});break;
                    case 6:customBordersPlugin.clearBorders(hot.getSelectedRange());break;
                    default:alloutDrawBroders();break;
                }
                function alloutDrawBroders(){
                    customBordersPlugin.setBorders([[x1,x2,x1,y2]], {top:{width: 1, color: 'black'}});
                    customBordersPlugin.setBorders([[x1,x2,y1,x2]], {left:{width: 1, color: 'black'}});
                    customBordersPlugin.setBorders([[x1,y2,y1,y2]], {right:{width: 1, color: 'black'}});
                    customBordersPlugin.setBorders([[y1,x2,y1,y2]], {bottom:{width: 1, color: 'black'}});
                }
              /*  console.log(JSON.stringify(customBordersPlugin.getBorders()));*/
            });
            //fontSize alignment
            $(".btn-group .btn").click(function(e) {
                var _index = $(this).index();
                var styleType = $(this).parent();
                var StyleClassName = '';
                var toggleSwitch = true;
                // 修改单元格文本样式
                if( styleType.hasClass("fontStyle") ){
                    var fontClass = "";
                    switch(_index){
                        case 0 : fontClass = "htBold"; // 加粗
                            break;
                        case 1 : fontClass = "htItalic"; // 斜体
                            break;
                        case 2: fontClass = "htUnderline"; // 下划线
                            break;
                    }
                    StyleClassName = fontClass;
                }
                // 修改单元格对齐方式
                if( styleType.hasClass("alignStyle") ){
                    var alignClass = "";
                    switch(_index){
                        case 0 : alignClass = "htLeft"; // 左对齐
                            break;
                        case 1 : alignClass = "htCenter"; // 居中对齐
                            break;
                        case 2 : alignClass = "htRight"; // 右对齐
                            break;
                        case 3 : alignClass = "htJustify"; // 两端对齐
                            break;
                    }
                    StyleClassName = alignClass;
                }
                // 修改所选区域所有单元格样式并赋予属性
                var  selectRangeArr = []; // 所选区域所有单元格数组
                selectRange = hot.getSelected(); // 获取所选区域范围
                console.log(selectRange);
                var rangeRowArr = []; // 所选区域行数组
                var rangeColArr = []; // 所选区域列数组
                for( var i=selectRange[0][0];i<selectRange[0][2]+1;i++ ){
                    rangeRowArr.push(i);
                }
                for( var i=selectRange[0][1];i<selectRange[0][3]+1;i++ ){
                    rangeColArr.push(i);
                }
                for( var i=0;i<rangeRowArr.length;i++ ){
                    for( var n=0;n<rangeColArr.length;n++ ){
                        var selectRangeCell = { row:rangeRowArr[i],col:rangeColArr[n] };
                        selectRangeArr.push(selectRangeCell);
                    }
                }
                for( var m=0;m<selectRangeArr.length;m++ ){
                    var rangeCell = hot.getCell(selectRangeArr[m].row, selectRangeArr[m].col);
                    var checkMergeCell = $(rangeCell).attr("rowspan");
                    if(styleType.hasClass("alignStyle")){
                        $(rangeCell).removeClass("htLeft htCenter htRight htJustify");
                    }
                    // 定义修改类名 创建对应属性方法
                    var setRangeCellClass = function(){
                        $(rangeCell).toggleClass(StyleClassName);
                        var cellClass = $(rangeCell)[0].className;
                        hot.setCellMeta(selectRangeArr[m].row, selectRangeArr[m].col,"className",cellClass);
                    };
                    if( checkMergeCell != undefined&&!styleType.hasClass("alignStyle") ){
                        if( toggleSwitch ){
                            setRangeCellClass();
                            toggleSwitch = false;
                        }else{
                            continue;
                        }
                    }else{
                        setRangeCellClass();
                    }
                }
            });

            $(".btn-line").click(function(e) {
                // 修改所选区域所有单元格样式并赋予属性
                var selectRangeArr = []; // 所选区域所有单元格数组
                var selectRange = hot.getSelected(); // 获取所选区域范围
                if(!selectRange){
                    $.messager.alert("警告","请选择列");
                    return;
                }
                var column=selectRange[0][1];
                var title=hot.getColHeader(selectRange[0][1]);

                var  $container=$('<div id="repirt"></div>');
                $container.iDialog({
                    title: "列设置",
                    width:400,
                    height:200,
                    buttons: [{
                        text: '确认',
                        iconCls: 'fa fa-save',
                        btnCls: 'gui-btn-save',
                        handler: function () {
                           var data=DataBind.collectData($('#repirt'));
                           var map={
                               Y:false,N:true
                           };
                            if(hideCol.indexOf(column)==-1){
                                hideColumns.push({
                                    visible:map[data.hide],
                                    col:column,
                                    condition:data.reason
                                });
                                hideCol.push(column);
                            }else{
                                $.each(hideColumns,function (n,ite) {
                                    if(ite.col==column){
                                        hideColumns[n]={
                                            visible:map[data.hide],
                                            col:column,
                                            condition:data.reason
                                        };
                                    }
                                });
                            }
                            $('#repirt').window('close');
                        }
                    },{
                        text:'取消',
                        iconCls: "fa fa-close",
                        btnCls: "gui-btn-danger",
                        handler:function () {
                            $container.iDialog('close');
                        }
                    }],
                    onOpen:function ($container) {
                        $('#repirt').find("input[name='reason']").iTextbox({value:''});
                        $('#repirt').find("input[name='hide']").prop('checked',false);
                       $.each(hideColumns,function (i,item) {
                           if(item.col==column){
                               $('#repirt').find("input[textboxname='reason']").textbox({value:item.condition});
                               if(item.visible!=undefined&&!item.visible){
                                   $('#repirt').find("input[name='hide']").prop('checked',true);
                               }
                               return false;
                           }
                           
                       })
                    },
                    onClose: function () {
                        $(this).form("clear");
                        $(this).iDialog('destroy');
                    }

                });
                var $div=$('<div class="editTable" style="margin:20px 40px"><form action="">' +
                    '<div><input type="checkbox" name="hide"><label for="">隐藏</label></div>' +
                    '<div><label for="">输出条件</label><input type="text" name="reason"></div>' +
                    '</form></div>');
                $container.html('').append($div);
                $container.iDialog('open');

            });
            $(".btn-row").click(function(e) {
                // 修改所选区域所有单元格样式并赋予属性
                var selectRangeArr = []; // 所选区域所有单元格数组
                var selectRange = hot.getSelected(); // 获取所选区域范围
                if(!selectRange){
                    $.messager.alert("警告","请选择行");
                    return;
                }
                var row=selectRange[0][0];
                var title=hot.getColHeader(selectRange[0][0]);

                var  $container=$('<div id="repirt_row"></div>');
                $container.iDialog({
                    title: "行设置",
                    width:400,
                    height:200,
                    buttons: [{
                        text: '确认',
                        iconCls: 'fa fa-save',
                        btnCls: 'gui-btn-save',
                        handler: function () {
                            var data=DataBind.collectData($('#repirt_row'));
                            var map={
                                Y:false,N:true
                            };
                            if(hideRow.indexOf(row)==-1){
                                hideRows.push({
                                    visible:map[data.hide],
                                    row:row,
                                    condition:data.reason
                                });
                                hideRow.push(row);
                            }else{
                                $.each(hideRows,function (n,ite) {
                                    if(ite.row==row){
                                        hideRows[n]={
                                            visible:map[data.hide],
                                            row:row,
                                            condition:data.reason
                                        };
                                    }
                                });
                            }
                            $('#repirt_row').window('close');
                        }
                    },{
                        text:'取消',
                        iconCls: "fa fa-close",
                        btnCls: "gui-btn-danger",
                        handler:function () {
                            $container.iDialog('close');
                        }
                    }],
                    onOpen:function ($container) {
                        $('#repirt_row').find("input[name='reason']").iTextbox({value:''});
                        $('#repirt_row').find("input[name='hide']").prop('checked',false);
                        $.each(hideRows,function (i,item) {
                            if(item.row==row){
                                $('#repirt_row').find("input[textboxname='reason']").textbox({value:item.condition});
                                if(item.visible!=undefined&&!item.visible){
                                    $('#repirt_row').find("input[name='hide']").prop('checked',true);
                                }
                                return false;
                            }
                            
                        })
                    },
                    onClose: function () {
                        $(this).form("clear");
                        $(this).iDialog('destroy');
                    }

                });
                var $div=$('<div class="editTable" style="margin:20px 40px"><form action="">' +
                    '<div><input type="checkbox" name="hide"><label for="">隐藏</label></div>' +
                    '<div><label for="">输出条件</label><input type="text" name="reason"></div>' +
                    '</form></div>');
                $container.html('').append($div);
                $container.iDialog('open');

            });
        },
        text: '报表设计',
        iconCls: 'fa fa-chain'
    });
    $('#reportTemp .toolbar-design-v2').iMenubutton({
        onClick: function () {

            var record = $('#reportTemp').find('.toolbar-table').datagrid('getSelected');
            if (!!!record) {
                $.messager.alert('提示', '请选择一条记录');
                return false;
            }

            //弹出即全屏
         /*   var index = layer.open({
                type: 2,
                title: false,
                closeBtn: false,
                shade: false,
                area: ['893px', '600px'],
                content: 'report/reporttemp/design/v2/' + record["id"]
            });

            layer.full(index);*/
             $('<div class="firm_cld" style="position:relative;overflow-y: hidden">').iDialog({
                width:800,
                height:640,
                title:'报表设计',
                maximized: 1,
                onClose: function () {
                    $(this).form("clear");
                    $(this).iDialog('destroy');
                },
                onOpen:function () {
                    var iframe=$('<iframe style="width: 100%;height: 100%"/>');
                    iframe.attr("src",'report/reporttemp/design/v2/' + record["id"]);
                    $(this).append(iframe);

                }
            });
            $('.firm_cld').iDialog('open');

        },

        text: '报表设计',
        iconCls: 'fa fa-chain'
    });



 /*  cell();
    line({
        title:'列属性',
        type:'line'
    });
    line({
        title:"行属性",
        type:"row"
    });
    page({
        title:"页面属性",
        type:"page"
    });*/
    function cell(initValue,config,f1) {
        var $container = $('<div style="position:relative;padding: 20px"></div>');
        $container.iDialog({
            title: "设置单元格格式",
            width: 600,
            height:600,
            buttons: [{
                text: '确认',
                iconCls: 'fa fa-save',
                btnCls: 'gui-btn-save',
                handler: function () {
                    var type=$(target.find(".formater_left input[name='type']")).val();
                    var data={
                        type:type,
                        value:$(target.find(".formater_right input[name='value']")).val()
                    };
                    switch (type) {
                        case "number":
                            data["value"]=data.value.replace(/,/g, "#");
                            data.options={
                                dec:$(target.find("input[name='data']")).val(),
                                ismillion:$(target.find("input[name='ismillion']")).val()
                            };
                            break;
                        case "money":
                            data.options={
                                dec:$(target.find("input[name='data_bin']")).val(),
                                currency:$(target.find("input[name='type_bin']")).val()
                            };
                            break;
                        case "percent":
                            data.options={
                                dec:$(target.find("input[name='data_percent']")).val()
                            };
                            break;
                    }

                    f1(data);
                    $container.iDialog('destroy');
                }
            },{text:'取消', iconCls: "fa fa-close", btnCls: "gui-btn-danger", handler:function () {$container.iDialog('close');}}],
            onOpen:function () {
                var left_box=$('<div class="formater_left"></div>').appendTo(target);
                var left_navbar='<ul>' +
                    '<input type="hidden" name="type" value="1"/>'+
                    '<li class="active"><a href="javascript:void(0)" data-options="value:text">文本</a></li>' +
                    '<li><a href="javascript:void(0)" data-options="value:number">数值</a></li>' +
                    '<li><a href="javascript:void(0)" data-options="value:money">货币</a></li>' +
                    '<li><a href="javascript:void(0)" data-options="value:date">日期</a></li>' +
                    '<li><a href="javascript:void(0)" data-options="value:time">时间</a></li>' +
                    '<li><a href="javascript:void(0)" data-options="value:percent">百分比</a></li>' +
                    '</ul>';
                left_box.append(left_navbar);
                var right_box=$('<div class="formater_right"></div>').appendTo(target);
                var right_content=$('<div><p class="right_li"><label for="">示例</label><input type="text" name="value" readonly style="border: none;display: block;width: 90%"></p><div class="content"></div></div>');
                right_box.append(right_content);
                var footer=$('<div class="formater_footer"></div>').appendTo(target);
                var keyEle= $(target.find(".formater_left input[name='type']"));
                var valueEle= $(target.find("input[name='value']"));
                /*常规*/
                var content1=$("<p class='box'>常规单元格格式不包含任何特定的数字格式。</p>");
                /*数值初始化*/
                var content2=$("<div class='box'><p><label>小数位数：</label><input type='text' name='data'></p>" +
                    "<p><input type='checkbox' name='ismillion'><label style='margin-left: 20px'>使用千位分隔符</label></p>"+
                    "<p>负数:</p>"+
                    '<ul class="content2_ul" style="height:134px">' +
                    '<li><a data-options="value:1" href="javascript:void(0)" class="red">(1234)</a></li>'+
                    '<li><a data-options="value:2" href="javascript:void(0)">(1234)</a></li>'+
                    '<li><a data-options="value:3" href="javascript:void(0)" class="red">1234</a></li>'+
                    '<li class="active"><a data-options="value:4" href="javascript:void(0)">-1234</a></li>'+
                    '<li><a data-options="value:5" href="javascript:void(0)" class="red">-1234</a></li>'+
                    '</ul>'+
                    "</div>");
                var content2_footer=$("<p>数值格式用于一般数字的表示。货币和会计格式则提供货币值计算的专用格式。</p>");
                content2.find("input[name='data']").numberspinner({min:0,max:99,value:2,onChange:function (value,text) {
                        var isq=content2.find("input[name='ismillion']").val();
                        if(isq==="Y"){
                            var formatter=valueEle.val().replace(/,|\s/g,'');
                            valueEle.val( RetainedDecimalPlaces(formatter,parseInt(content2.find("input[name='data']").val())))
                        }else{
                            valueEle.val(parseFloat(valueEle.val()).toFixed(value));
                        }
                    }, inputEvents: $.extend({}, $.fn.textbox.defaults.inputEvents, {
                        keyup: function test(event) {
                            var value=$(this).val();
                            valueEle.val(parseFloat(valueEle.val()).toFixed(value));
                        }
                    })});
                var number_isM="N";
                if(config&&config.options){
                    number_isM=config.options.ismillion
                }
                mCheckbox.create(content2.find("input[name='ismillion']"),{Y:'Y',N:'N',value:number_isM,callback:function () {
                        var value=content2.find("input[name='ismillion']").val();
                        if(value==="Y"){
                            valueEle.val( RetainedDecimalPlaces(valueEle.val(),content2.find("input[name='data']").val()))
                        }else{
                            valueEle.val(valueEle.val().replace(/,|\s/g,''));

                        }
                    }});


                /*货币初始化*/
                var content3=$("<div class='box'>" +
                    "<p><label>小数位数：</label><input type='text' name='data_bin'></p>" +
                    "<p><label>货币符号（国家/地区）：</label><input type='text' name='type_bin'></p>" +
                    "<p>负数:</p>"+
                    '<ul class="content2_ul" style="height:120px">' +
                    '<li><a href="javascript:void(0)" class="red">(¥1234)</a></li>'+
                    '<li><a href="javascript:void(0)">(¥1234)</a></li>'+
                    '<li><a href="javascript:void(0)" class="red">¥1234</a></li>'+
                    '<li class="active"><a href="javascript:void(0)">¥-1234</a></li>'+
                    '<li><a href="javascript:void(0)" class="red">¥-1234</a></li>'+
                    '</ul>'+
                    "</div>");
                var content3_footer=$("<p>货币格式用于表示一般货币数值。会计格式可以对一列数值进行小数点对齐。</p>");
                content3.find("input[name='data_bin']").numberspinner({min:0,max:99,value:2,onChange:function (value,text) {
                        var money=content3.find("input[name='type_bin']").val();
                        valueEle.val(money+parseFloat(initValue).toFixed(value));
                    }, inputEvents: $.extend({}, $.fn.textbox.defaults.inputEvents, {
                        keyup: function test(event) {
                            var value=$(this).val();
                            var money=content3.find("input[name='type_bin']").val();
                            valueEle.val(money+parseFloat(initValue).toFixed(value));
                        }
                    })});
                ComboboBox.init(content3.find("input[name='type_bin']"),{data:[{value:"¥",text:"¥",selected:1},{value:"$",text:"$"}],valueField:"value",textField:"text",onSelected:function (value) {
                        if(valueEle){
                            valueEle.val(value.value+parseFloat(initValue).toFixed(content3.find("input[name='data_bin']").val()));
                            var element=content3.find("ul.content2_ul li");
                            element.each(function (i,ele) {
                                if($(ele).text().indexOf('¥')>-1){
                                    $(ele).text($(ele).text().replace('¥', value.value));
                                }else if($(ele).text().indexOf('$')>-1){
                                    $(ele).html($(ele).text().replace('$', value.value))
                                }
                            });


                        }

                    }});

                /*日期初始化*/
                var date=new Date();
                var content4=$("<div class='box'><p>类型:</p><ul class='content2_ul'></ul></div>");
                var date_type={
                    1:date.Format("yyyy/MM/dd"),
                    2:date.Format("yyyy年MM月dd日"),
                    3:date.Format("yyyy-MM-dd"),
                    4:date.Format("yyyy年"),
                    5:date.Format("MM月dd日"),
                    6:"周"+date.getDay()
                };
                for(var i in date_type){content4.find('.content2_ul').append( '<li><a href="javascript:void(0)" value="'+i+'">'+date_type[i]+'</a></li>');}
                $(content4.find('.content2_ul li')[0]).addClass('active');
                var content4_footer=$("<p>日期格式将日期和时间系类数值显示为日期值</p>");

                /*时间初始化*/
                var content5=$("<div class='box'><p>类型:</p><ul class='content2_ul'></ul></div>");
                var time_type={
                    1:date.Format("hh:mm:ss"),
                    2:date.Format("hh:mm"),
                    3:date.Format("hh时mm分ss秒"),
                    4:date.Format("hh时mm分")
                };
                for(var i in time_type){content5.find('.content2_ul').append('<li><a href="javascript:void(0)" value="'+i+'">'+time_type[i]+'</a></li>');}
                $(content5.find('.content2_ul li')[0]).addClass('active');
                var content5_footer=$("<p>时间格式将日期和时间系类数值显示为时间值</p>");

                /*百分比初始化*/
                var content6=$("<div class='box'><p><label>小数位数：</label><input type='text' name='data_percent'></p></div>");
                var content6_footer=$("<p>百分比格式将单元格中数值乘以100,并以百分数形式显示</p>");
                content6.find("input[name='data_percent']").numberspinner({min:0,max:99,value:2,onChange:function (value,text) {
                        valueEle.val((parseFloat(initValue)*100).toFixed(value)+'%');
                    }, inputEvents: $.extend({}, $.fn.textbox.defaults.inputEvents, {
                        keyup: function test(event) {
                            var value=$(this).val();
                            valueEle.val((parseFloat(initValue)*100).toFixed(value)+"%");
                        }
                    })});

                $(target.find(".formater_left li")).each(function (i,l) {
                    $(this).click(function () {
                        var option=$(this).children("a").data().options.split(":");
                        $(target.find(".formater_left li")).removeClass("active");
                        $(this).addClass("active");
                        var key=option[0],value=option[1];
                        right_content.find(".box").css("display","none");
                        footer.html("");
                        switch (value) {
                            case "text":$(right_content.find(".box")[0]).css("display","block");valueEle.val(initValue);break;
                            case "number":$(right_content.find(".box")[1]).css("display","block");valueEle.val(parseFloat(initValue).toFixed(content2.find("input[name='data']").val()));content2_footer.appendTo(footer);break;
                            case "money":$(right_content.find(".box")[2]).css("display","block");valueEle.val(content3.find("input[name='type_bin']").val()+parseFloat(initValue).toFixed(content3.find("input[name='data_bin']").val()));content3_footer.appendTo(footer);break;
                            case "date":$(right_content.find(".box")[3]).css("display","block");valueEle.val(content4.find("li.active").text());content4_footer.appendTo(footer);break;
                            case "time":$(right_content.find(".box")[4]).css("display","block");valueEle.val(content5.find("li.active").text());content5_footer.appendTo(footer);break;
                            case "percent":$(right_content.find(".box")[5]).css("display","block");valueEle.val((parseFloat(initValue)*100).toFixed(content6.find("input[name='data_percent']").val())+"%");content6_footer.appendTo(footer);break;
                            default:break;
                        }
                        keyEle.val(value);

                    })
                });
                content1.appendTo(right_content.find(".content"));
                content2.appendTo(right_content.find(".content"));
                content3.appendTo(right_content.find(".content"));
                content4.appendTo(right_content.find(".content"));
                content5.appendTo(right_content.find(".content"));
                content6.appendTo(right_content.find(".content"));
                right_content.find(".box").css("display","none");$(right_content.find(".box")[0]).css("display","block");
                $(target.find(".formater_right input[name='value']")).val(initValue);
                if(config){
                    right_content.find(".box").css("display","none");
                    footer.html("");
                    $(target.find(".formater_left li")).removeClass("active");
                    $.each(target.find(".formater_left li"),function (i,item) {
                        var option=$(this).children("a").data().options.split(":")[1];
                        if(option===config.type){
                            $(this).addClass("active");
                        }
                    });

                    var value=config.type;
                    $(target.find(".formater_left input[name='type']")).val(value);
                    switch (value) {
                        case "text":$(right_content.find(".box")[0]).css("display","block");valueEle.val(initValue);break;
                        case "number":$(right_content.find(".box")[1]).css("display","block");
                            content2.find("input[textboxname='data']").numberspinner({value:config.options.dec});
                            if(config.options.ismillion==="Y"){
                                valueEle.val( RetainedDecimalPlaces(parseFloat(initValue),content2.find("input[name='data']").val()))
                            }else{
                                valueEle.val(parseFloat(initValue).toFixed(content2.find("input[name='data']").val()));

                            }
                                        content2_footer.appendTo(footer);
                                        break;
                        case "money":$(right_content.find(".box")[2]).css("display","block");
                                content3.find("input[textboxname='data_bin']").numberspinner({value:config.options.dec});
                                content3.find("input[textboxname='type_bin']").textbox({value:config.options.currency})
                                valueEle.val(content3.find("input[name='type_bin']").val()+parseFloat(initValue).toFixed(content3.find("input[name='data_bin']").val()));
                                content3_footer.appendTo(footer);break;
                        case "date":$(right_content.find(".box")[3]).css("display","block");valueEle.val(content4.find("li.active").text());content4_footer.appendTo(footer);break;
                        case "time":$(right_content.find(".box")[4]).css("display","block");valueEle.val(content5.find("li.active").text());content5_footer.appendTo(footer);break;
                        case "percent":$(right_content.find(".box")[5]).css("display","block");valueEle.val((parseFloat(initValue)*100).toFixed(content6.find("input[name='data_percent']").val())+"%");content6_footer.appendTo(footer);break;
                        default:break;
                    }
                }

                f(content2);
                f(content3);
                f(content4);
                f(content5);
                f(content6);

                function f(content) {
                    content.find("li").each(function (i,l) {
                        $(this).click(function () {
                            content.find("li").removeClass("active");
                            $(this).addClass("active");
                            var type=keyEle.val();
                            switch (parseInt(type)) {
                                case 4 :f1(this);break;
                                case 5 :f1(this);break;
                            }
                            function f1(ele) {
                                valueEle.val($(ele).text())
                            }
                        })
                    });
                }


            },
            onDestroy:function(){
            },
            onClose: function () {
                $(this).form("clear");
                $(this).iDialog('destroy');
            }
        });
        var target=$('<div style="position: relative"><p>分类:</p></div>');
        $container.html('').append(target);
        $container.iDialog('open');
        /*使用千位分割符*/
        function RetainedDecimalPlaces(num, del) //值：num 小数位：del
        {
            if (del != 0)
            {
                num = parseFloat(num).toFixed(del); //天花板函数保留小数并四舍五入
            }else{
                num=parseInt(num);
            }

            var source = String(num).split(".");//按小数点分成2部分
            source[0] = source[0].replace(new RegExp('(\\d)(?=(\\d{3})+$)', 'ig'), "$1,");//只将整数部分进行都好分割
            return source.join(".");//再将小数部分合并进来
        }
    }
    function line(opt) {
        var $container_line = $('<div style="position:relative;padding: 20px"></div>');
        $container_line.iDialog({
            title: opt.title,
            width: 600,
            height:320,
            buttons: [{
                text: '确认',
                iconCls: 'fa fa-save',
                btnCls: 'gui-btn-save',
                handler: function () {
                    var data={
                        isHidden:$container_line.find("input").val(),
                        reason:$container_line.find("textarea").val()
                    };
                    alert(JSON.stringify(data));
                }
            },{text:'取消', iconCls: "fa fa-close", btnCls: "gui-btn-danger", handler:function () {$container_line.iDialog('close');}}],
            onOpen:function () {
                var left_box=$('<div class="line_left" style="padding-top: 20px;border-top: 1px solid lightgrey"></div>').appendTo(target_line);
                var i=$("<i style='position: absolute;left: 4px;top: -8px;background-color: white'>特殊效果<i/>").appendTo(left_box);
                mCheckbox.init(left_box,{Y:'Y',N:'N',value:"N"},"隐藏");
                var left_textarea=$('<p style="margin-top: 20px;"><label style="margin-bottom: 10px;display: block" for="">隐藏条件</label><textarea name="reason" multiline="true"' +
                    ' style="height: 80px;width:100%;padding:4px;border: 1px solid lightgrey"></textarea></p>');
                left_textarea.appendTo(left_box);
            },
            onDestroy:function(){
            },
            onClose: function () {
                $(this).form("clear");
                $(this).iDialog('destroy');
            }
        });
        var target_line=$('<div style="position: relative"></div>');
        $container_line.html('').append(target_line);
        $container_line.iDialog('open');
    }
    function page(opt) {
        var $container = $('<div style="position:relative;padding: 20px"></div>');
        $container.iDialog({
            title: opt.title,
            width: 600,
            height:320,
            buttons: [{
                text: '确认',
                iconCls: 'fa fa-save',
                btnCls: 'gui-btn-save',
                handler: function () {
                    var data={
                        showGrid:$container.find('input[name="showGrid"]').val(),
                        isRun:$container.find('input[name="isRun"]').val(),
                        isRow:$container.find('input[name="isRow"]').val(),
                        isLine:$container.find('input[name="isLine"]').val(),
                    };
                    alert(JSON.stringify(data));
                }
            },{text:'取消', iconCls: "fa fa-close", btnCls: "gui-btn-danger", handler:function () {$container.iDialog('close');}}],
            onOpen:function () {
                var left_box=$('<div class="line_left" style="padding-top: 20px;border-top: 1px solid lightgrey"></div>').appendTo(target);
                var i=$("<i style='position: absolute;left: 4px;top: -8px;background-color: white'>界面效果<i/>").appendTo(left_box);
                var input1=$("<p><input type='checkbox' name='showGrid'><label style='margin-left: 20px'>背景线</label></p>").appendTo(left_box);
                var input2=$("<p><input type='checkbox' name='isRow'><label style='margin-left: 20px'>行号</label></p>").appendTo(left_box);
                var input3=$("<p><input type='checkbox' name='isLine'><label style='margin-left: 20px'>列号</label></p>").appendTo(left_box);
                var input4=$("<p><input type='checkbox' name='isRun'><label style='margin-left: 20px'>是否为运行期</label></p>").appendTo(left_box);
                mCheckbox.create(input1.find("input[name='showGrid']"),{Y:'Y',N:'N',value:"N"});
                mCheckbox.create(input2.find("input[name='isRow']"),{Y:'Y',N:'N',value:"N"});
                mCheckbox.create(input3.find("input[name='isLine']"),{Y:'Y',N:'N',value:"N"});
                mCheckbox.create(input4.find("input[name='isRun']"),{Y:'Y',N:'N',value:"N"});
            },
            onDestroy:function(){
            },
            onClose: function () {
                $(this).form("clear");
                $(this).iDialog('destroy');
            }
        });
        var target=$('<div style="position: relative"></div>');
        $container.html('').append(target);
        $container.iDialog('open');
    }



});

    $('#reportTemp .toolbar-publish').iMenubutton({
        onClick: function () {
            var record = $('#reportTemp').find('.toolbar-table').datagrid('getSelected') || {};
            if ( record==null || record == undefined ) {
                $.messager.alert('提示','请选择一条记录进行发布');
                return false;
            }

            HTTP.post('report/reporttemp/creategnmk',{bbbm:  record["bbbm"] },function (result) {
                console.log(result.data);
                if ( result.success ){
                    $.messager.alert('信息','报表功能[' + record["bbbm"]  + ']发布成功');
                } else {
                    $.messager.alert('信息', result.message || ('报表功能[' + record["bbbm"]  + ']发布失败'));
                }
            });

        },
        text: '功能发布',
        iconCls: 'fa fa-share'
    });

    $('#reportTemp .toolbar-unpublish').iMenubutton({
        onClick: function () {

            var record = $('#reportTemp').find('.toolbar-table').datagrid('getSelected');
            if ( record==null || record == undefined ) {
                $.messager.alert('提示','请选择一条已发布功能进行取消操作');
                return false;
            }

            HTTP.post('report/reporttemp/unpublish',{bbbm:  record["bbbm"] },function (result) {
                console.log(result.data);
                if ( result.success ){
                    $.messager.alert('信息','报表功能[' + record["bbbm"]  + ']取消成功');
                } else {
                    $.messager.alert('信息', result.message || ('报表功能[' + record["bbbm"]  + ']取消失败'));
                }
            });

        },
        text: '取消发布',
        iconCls: 'fa fa-ban'
    });


    $(function () {
        $("#reportTemp input[name='start']").iDatebox({});
        $("#reportTemp input[name='end']").iDatebox({});

        var $div=$('#reportTemp');
        var options={
            url:'report/reporttemp',
            columns:[[
                {title: "ID", index: 10, field: "id", width: 160, halign:'center', align: 'left',  hidden: true },
                {title: "报表编码", index: 20, field: "bbbm", width: 160, halign:'center', align: 'left',  hidden: false },
                {title: "组织ID", index: 30, field: "orgid", width: 160, halign:'center', align: 'left',  hidden: true },
                {title: "报表名称", index: 40, field: "bbmc", width: 160, halign:'center', align: 'left',  hidden: false },
                {title: "报表类型", index: 50, field: "bblx", width: 120, halign:'center', align: 'center',  hidden: false,
                    formatter:function (value) {
                        return {D: '日报表', M: '月报表', Y: '年报表' }[value] || value;
                    }
                },
                {title: "名称生成规则", index: 60, field: "scgz", width: 160, halign:'center', align: 'left',  hidden: false },
                {title: "报表种类", index: 60, field: "bbzl", width: 160, halign:'center', align: 'left',  hidden: true },
                {title: "报表分类", index: 70, field: "bbfl", width: 160, halign:'center', align: 'left',  hidden: true },
                {title: "报表内容", index: 80, field: "bbnr", width: 160, halign:'center', align: 'left',  hidden: true },
                {title: "报表统计开始点", index: 90, field: "ksd", width: 160, halign:'center', align: 'left',  hidden: false },
                {title: "停用标志", index: 100, field: "tybz", width: 100, halign:'center', align: 'left',  hidden: false },
                {title: "停用日期", index: 110, field: "tyrq", width: 160, halign:'center', align: 'center',  hidden: false , formatter:function (value) {
                        if ( value==undefined || value =='' ){
                            return "";
                        }
                        var date = new Date(parseInt(value));
                        if ( isNaN(date) ){
                            return ""
                        }
                        return date.Format("yyyy-MM-dd");
                    }
                },
                {title: "备注", index: 120, field: "bz", width: 160, halign:'center', align: 'left',  hidden: false },
                {title: "系统版本", index: 130, field: "sysversion", width: 160, halign:'center', align: 'left',  hidden: true },
                {title: "维护人编码", index: 140, field: "whrid", width: 160, halign:'center', align: 'left',  hidden: true },
                {title: "维护人", index: 150, field: "whr", width: 160, halign:'center', align: 'left',  hidden: false },
                {title: "维护时间", index: 160, field: "whsj", width: 160, halign:'center', align: 'center',  hidden: false , formatter:function (value) {
                        if ( value==undefined || value =='' ){
                            return "";
                        }
                        var date = new Date(parseInt(value));
                        if ( isNaN(date) ){
                            return ""
                        }
                        return date.Format("yyyy-MM-dd hh:mm:ss");
                    }
                },
                {title: "创建人编码", index: 170, field: "cjrid", width: 160, halign:'center', align: 'left',  hidden: true },
                {title: "创建人", index: 180, field: "cjr", width: 160, halign:'center', align: 'left',  hidden: false },
                {title: "创建时间", index: 190, field: "cjsj", width: 160, halign:'center', align: 'center',  hidden: false , formatter:function (value) {
                        if ( value==undefined || value =='' ){
                            return "";
                        }
                        var date = new Date(parseInt(value));
                        if ( isNaN(date) ){
                            return ""
                        }
                        return date.Format("yyyy-MM-dd hh:mm:ss");
                    }
                }
            ]],
            dialog:{
                id:'reportTempEdit',
                width: 1000,
                height: 600,
                href:'report/reporttemp/edit'
            }
        };
        $div.Container(options);
    });

</script>