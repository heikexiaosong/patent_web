<style>
    .btn {
        display: inline-block;
        padding: 6px 8px;
        margin-bottom: 0;
        font-size: 14px;
        font-weight: 400;
        line-height: 1.42857143;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        -ms-touch-action: manipulation;
        touch-action: manipulation;
        cursor: pointer;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        background-image: none;
        border: 1px solid transparent;
        border-radius: 4px;
    }

    .form-cfg {
        margin: 10px;
    }

    .btn-success {
        margin-top: 10px;
        margin-left: 12px;
        color: #fff;
        background-color: #61ba9e;
        border-color: #4fb393;
    }

    .btn-draggable {
        margin-top: 10px;
        margin-left: 12px;
        color: #fff;
        background-color: #25c7ff;
        border-color: #4fb393;
    }

    @media all {
        .layui-icon {
            -webkit-user-select: none;
            -ms-user-select: none;
            -moz-user-select: none;
        }

        div, p {
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
        }

        .layui-icon {
            font-family: layui-icon !important;
            font-size: 16px;
            font-style: normal;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .layui-upload-drag {
            display: inline-block;
        }

        .layui-upload-drag {
            position: relative;
            margin: 7px;
            padding: 64px;
            border: 1px dashed #e2e2e2;
            background-color: #fff;
            text-align: center;
            cursor: pointer;
            color: #999;
        }

        .layui-upload-drag .layui-icon {
            font-size: 50px;
            color: #009688;
        }
    }

    @media all {
        ::-webkit-input-placeholder {
            color: #999;
        }
    }

    @font-face {
        font-family: layui-icon;
        src: url(https://res.layui.com/layui/dist/font/iconfont.eot?v=240);
        src: url(https://res.layui.com/layui/dist/font/iconfont.eot?v=240#iefix) format('embedded-opentype'), url(https://res.layui.com/layui/dist/font/iconfont.svg?v=240#iconfont) format('svg'), url(https://res.layui.com/layui/dist/font/iconfont.woff?v=240) format('woff'), url(https://res.layui.com/layui/dist/font/iconfont.ttf?v=240) format('truetype');
    }
</style>


<div class="easyui-layout" style="width:100%">
    <div data-options="region:'east',title:'East',split:false"
         style="width: 75%; overflow: hidden; display: inline-block">
        <div id="configure" style="width: 100%; height:100%; display: inline-block; overflow: auto"
             class="gui-div panel-scroll">
            <canvas width="1600" height="920" id="canvas"></canvas>
        </div>


        <div id="status" style="width: 100%; height: 30px; display: inline-block; overflow: auto"
             class="gui-div panel-scroll">
            编码:
            名称:
            宽:
            高:
        </div>

    </div>
    <div data-options="region:'center',title:'Center',split:false"
         style="width: 4%; overflow: hidden; display: inline-block; position: absolute;">

        <div class="row  text-center">
            <a class="btn btn-success" id="cfgOpen"><i class="fa fa-folder-open"/></a>
            <a class="btn btn-success" id="cfgSave"><i class="fa fa-save"/></a>


            <a class="btn btn-success" onclick="setBackgroundImage()"><i class="fa fa-image"/></a>

            <a class="btn btn-draggable" draggable="true"> <i class="fa fa-chain"/> </a>

            <a class="btn btn-success" id="cfgExport"><i class="fa fa-upload"/></a>


        </div>
    </div>
    <div id="attrs" data-options="region:'west',title:'West',split:true" style="width: 20%; float: right">
        <div class="easyui-layout" style="width:100%; height: 100%">
            <div data-options="region:'north',title:'属性',split:true" style="width:100%; height: 100%">
                <table class="attrTable" title="属性" style="width:100%; height: 100%"></table>
            </div>
            <div data-options="region:'center',title:'数据点',split:true" style="height: 100%">
                <ul class="pointList" title="数据点" style="height:350px">
                </ul>
            </div>

        </div>

    </div>

</div>


<script>

    // 设置组态图背景图片
    function setBackgroundImage(ev) {

        var html =
            '<form enctype="multipart/form-data" method="post" name="fileinfo" style="margin: 20px 20px 0 30px;">' +
            ' <input type="hidden" name="groupid" value="cnfg" > ' +
            '  <label>背景图片:</label>' +
            '  <input type="file" name="file" required />' +
            ' </form>' +
            '<div></div>';


        layer.open({
            type: 1,
            title: '设置背景图: ',
            area: ['400px', '160px'],
            content: html,
            btn: ['确定', '取消'],
            btn1: function (index, layero) {
                //按钮【按钮一】的回调

                var form = document.forms.namedItem("fileinfo");

                var oData = new FormData(form);

                $.ajax({
                    url: "attachment/upload",
                    type: "POST",
                    data: oData,
                    processData: false,  // 不处理数据
                    contentType: false,   // 不设置内容类型
                    success: function (result) {
                        var url = Object.values(result.data)[0];
                        cfg["backgroup"] = url;
                        fabric.Image.fromURL(Object.values(result.data)[0], function (img) {
                            canvas.setWidth(img.width);
                            canvas.setHeight(img.height);
                            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));

                            var htms = [];
                            htms.push('编码: ' + cfg["code"]);
                            htms.push('名称: ' + cfg["name"]);
                            htms.push('宽: ' + img.width);
                            htms.push('高: ' + img.height);
                            $("#status").html(htms.join(" "));

                            layer.close(index);
                        });
                    }
                });

            },

            btn2: function (index, layero) {
                return true;
            },

            success: function (layero, index) {
                HTTP.post("configure/configure/query", {}, function (result) {
                    var select = $(layero).find("select[name='code']");
                    select.empty();
                    $.each(result.data.records, function (i, record) {
                        var opt = select.append("<option value='" + record.code + "'>" + record.name + "</option>");
                        opt.find("option:last").data("data", record);
                    })

                })
            }
        });

    }

    function Attr(_name, _title, _obj) {
        this.name = _name;
        this.title = _title;
        this.data = _obj;
        this.value = _obj[_name];
    }


    function buildAttrs(_obj) {

        var target = _obj || {};

        var attrs = [];
        attrs.push(new Attr('name', '名称', target));
        attrs.push(new Attr('type', '数据引用', target));
        attrs.push(new Attr('unit', '单位', target));
        attrs.push(new Attr('left', 'x坐标', target));
        attrs.push(new Attr('top', 'y坐标', target));
        attrs.push(new Attr('fontSize', '字体大小', target));
        attrs.push(new Attr('textcolor', '字体颜色', target));
        attrs.push(new Attr('lower', '下限阀值', target));
        attrs.push(new Attr('lowercolor', '低值颜色', target));
        attrs.push(new Attr('upper', '上限阀值', target));
        attrs.push(new Attr('uppercolor', '高值颜色', target));

        return attrs;
    }
    function buildAttrsPicture(obj) {
        var target = obj || {};

        var attrs = [];
        attrs.push(new Attr('name', '名称', target));
        attrs.push(new Attr('type', '数据引用', target));
        attrs.push(new Attr('left', 'x坐标', target));
        attrs.push(new Attr('top', 'y坐标', target));
        return attrs;
    }
    (function (global) {

        var rtview = global.rtview || (global.rtview = { });

    })(typeof exports !== 'undefined' ? exports : this);

    var cfg = {};

    var canvas = new fabric.Canvas('canvas');

    var $attrTable = $('.attrTable');
    var $pointList = $('.pointList');



    var canvasWrapper = document.getElementById('configure');
    canvasWrapper.tabIndex = 1000;
    canvasWrapper.addEventListener("keydown", function (ev) { 

        if ( ev.code === 'Delete' ){
            var objects = canvas.getActiveObjects();

            if ( objects!=null && objects.length > 0 ){
                canvas.remove(objects[0]);
                canvas.requestRenderAll();
                $attrTable.edatagrid("loadData", []);

                var rows = $pointList.datalist("getRows");
                if ( rows !=null && rows.length > 0 ){

                    for (var i = 0; i < rows.length; i++) {

                        if ( objects[0].id === rows[i].value ){
                            $pointList.datalist("deleteRow", $pointList.datalist("getRowIndex", rows[i]));
                        }
                    }
                }
            }
        }
        }, false);

    // debugger;
    //
    // canvas.item(0)['hasRotatingPoint'] = false;
    // canvas.renderAll();

    //canvas.selection = true;
 /*   canvas.on('mouse:up', function (e) {
        debugger;
    });*/


    function createEle(title, name, prompt) {

        var htmls = [];

        htmls.push('<div class="layui-form-item" style="margin: 30px 15px;">');
        htmls.push('    <label class="layui-form-label">' + title + '</label>');
        htmls.push('    <div class="layui-input-inline" style="width: 220px;">');
        htmls.push('        <input type="text" name="' + name + '" placeholder="请输入' + title + '" autocomplete="off" class="layui-input">');
        htmls.push('    </div>');
        htmls.push('    <div class="layui-form-mid layui-word-aux aux-' + name + '" >' + (prompt || "") + '</div>');
        htmls.push('</div>');

        return htmls.join("\n");
    }

    function createSelectEle(title, name) {
        var htmls = [];
        htmls.push('<div class="layui-form-item">');
        htmls.push('    <label class="layui-form-label">' + title + '</label>');
        htmls.push('    <div class="layui-input-inline">');
        htmls.push('        <select name="' + name + '" lay-verify="required" class="layui-input"></select>');
        htmls.push('    </div>');
        htmls.push('</div>');

        return htmls.join("\n");
    }

    function createPictureEle(title, name,src) {

        var htmls = [];

        htmls.push('<div class="layui-form-item" style="margin: 30px 15px;">');
        htmls.push('    <label class="layui-form-label">' + title + '<img src="'+src+'" alt=""></label>');
        htmls.push('    <div class="layui-input-inline" style="width: 220px">');
        htmls.push('        <input type="text" name="' + name + '" placeholder="" autocomplete="off" class="layui-input"  onkeyup="(this.v=function(){this.value=this.value.replace(/[^0-9-]+/,\'\');}).call(this)" onblur="this.v()">');
        htmls.push('    </div>');
        htmls.push('</div>');

        return htmls.join("\n");
    }

    // 打开组态图
    $("#cfgOpen").on("click", function (ev) {
        var htmls = [];
        htmls.push('<div class="form-cfg">');
        htmls.push(createSelectEle('组态图', 'code'));
        htmls.push('</div>');
        layer.open({
            type: 1,
            title: '打开组态图: ',
            area: ['460px', '300px'],
            content: htmls.join(""),
            btn: ['确定', '取消'],
            btn1: function (index, layero) {
                //按钮【按钮一】的回调
                var selected = $(layero).find("select[name='code']").find("option:selected");

                cfg = {};
                cfg = selected.data("data");
                var htms = [];
                htms.push('编码: ' + cfg["code"]);
                htms.push('名称: ' + cfg["name"]);
                htms.push('宽: ' + cfg["width"]);
                htms.push('高: ' + cfg["height"]);
                $("#status").html(htms.join(" "));

                $("#status").data("data", cfg);

                //10：加载图片时图片缩放到指定的大小。
                fabric.Image.fromURL(cfg.backgroup, function (img) {
                    canvas.setWidth(img.width);
                    canvas.setHeight(img.height);
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                });

                HTTP.post("configure/item/query", {cfgcode: selected.val()}, function (response) {

                    var result = response.data.records;

                    console.log(result);
                    layer.close(index);
                    // 清空数据
                    var items = canvas.getObjects();
                    $.each(items, function (i, item) {
                        canvas.remove(item);
                    });
                    $attrTable.edatagrid("loadData", []);
                    $pointList.datalist("loadData", []);
                    $.each(result, function (i, item) {
                        if(item.type==="image"){
                            var textData = {
                                id: item.id,
                                left: Math.floor(item.posx), top: Math.floor(item.posy),
                                name: item["name"],
                                value: item.value|| '',
                                val: item.value|| '',
                                flag: "U",
                            };
                            var type="2";
                            if(item["value"]&&item["prop"]){
                               var props=JSON.parse(item.prop);
                               var on=props.on;
                               var off=props.off;
                               if(on.indexOf("-")>-1){
                                   var arry=on.split('-');
                                   var maxON=Math.max(arry[0],arry[1]);
                                   var minON=Math.min(arry[0],arry[1]);
                                   if(minON<=item.value<=maxON){
                                       type="1";
                                   }
                               }else{
                                   if(item.value===parseFloat(on)){
                                       type="1";
                                   }
                               }
                                if(off.indexOf("-")>-1){
                                    var arry=off.split('-');
                                    var maxON=Math.max(arry[0],arry[1]);
                                    var minON=Math.min(arry[0],arry[1]);
                                    if(minON<=item.value<=maxON){
                                        type="0";
                                    }
                                }else{
                                    if(item.value===parseFloat(off)){
                                        type="0";
                                    }
                                }
                            }

                            var url={"0":"css/icons/dot1.png","1":"css/icons/dot.png","2":"css/icons/dot2.png"};
                            fabric.Image.fromURL(url[type],function (text){
                                canvas.add(text);
                                text.on('selected', function () {
                                    var target = this;
                                    target.set({left: Math.floor(target.left), top: Math.floor(target.top)});
                                    $attrTable.edatagrid("loadData", buildAttrsPicture(target));
                                    $pointList.datalist("unselectAll");
                                    $pointList.datalist("selectRecord", target.id);

                                });
                                text.on('modified', function () {
                                    var target = this;
                                    target.set({left: Math.floor(target.left), top: Math.floor(target.top)});
                                    $attrTable.edatagrid("loadData", buildAttrsPicture(target));
                                    $pointList.datalist("unselectAll");
                                    $pointList.datalist("selectRecord", target.id);

                                });
                                var pointDatas = $pointList.datalist("getData") || {rows: [], total: 0};
                                pointDatas.rows.push({text: textData.name, value: item.id});
                                $pointList.datalist("loadData", pointDatas.rows);
                                $pointList.datalist("unselectAll");
                                $pointList.datalist("selectRecord", item.id);
                                canvas.setActiveObject(text);

                            },textData);

                        }else{
                            var textData = {
                                uid: item.id,
                                id: item.id,
                                left: Math.floor(item.posx), top: Math.floor(item.posy),
                                name: item["name"],
                                type: item["type"] || "RANDOM",
                                unit: item["unit"]||'',
                                fontSize: item.font || 12,
                                val: Math.random().toFixed(2),
                                fill: item.textcolor || 'red',
                                // stroke: item.textcolor || 'red',
                                flag: "U",
                                value: item.value||'',
                                textcolor:item["textcolor"]||'',
                                hasRotatingPoint: false
                            };
                            if (!!item.lower && item.lower >= item.val) {
                                textData.fill = item.lowercolor || item.textcolor;
                                // textData.stroke = item.lowercolor || item.textcolor;
                            }
                            if (!!item.upper && item.upper <= item.val) {
                                textData.fill = item.uppercolor || item.textcolor;
                                // textData.stroke = item.uppercolor || item.textcolor;
                            }
                            // {"name":"point_1", "posx":375, "posy":249,  "type":"RANDOM","unit":"mm"}
                            var text;
                            if (!!item.type && item.type === 'TEXT' ) {
                                text = new fabric.Text(item.value||'', textData);
                            } else {
                                text = new fabric.Text((item.val||"1.0") + " " + textData.unit, textData);
                            }

                            //text.set('selectable', false);
                            canvas.add(text);
                            text.on('selected', function () {
                                var target = this;
                                target.set({left: Math.floor(target.left), top: Math.floor(target.top)});
                                $attrTable.edatagrid("loadData", buildAttrs(target));
                                $pointList.datalist("unselectAll");
                                $pointList.datalist("selectRecord", target.id);

                            });
                            text.on('modified', function () {
                                var target = this;
                                target.set({left: Math.floor(target.left), top: Math.floor(target.top)});
                                $attrTable.edatagrid("loadData", buildAttrs(target));
                                $pointList.datalist("unselectAll");
                                $pointList.datalist("selectRecord", target.id);

                            });
                            var pointDatas = $pointList.datalist("getData") || {rows: [], total: 0};
                            pointDatas.rows.push({text: textData.name, value: item.id});
                            $pointList.datalist("loadData", pointDatas.rows);
                            $pointList.datalist("unselectAll");
                            $pointList.datalist("selectRecord", item.id);
                            canvas.setActiveObject(text);
                        }
                    });

                })

            },
            btn2: function (index, layero) {
                return true;
            },
            success: function (layero, index) {
                console.log(layero, index);

                HTTP.post("configure/configure/query", {}, function (result) {
                    var select = $(layero).find("select[name='code']");
                    select.empty();
                    $.each(result.data.records, function (i, record) {
                        var opt = select.append("<option value='" + record.code + "'>" + record.name + "</option>");
                        opt.find("option:last").data("data", record);
                    })

                })
            }
        });

    });

    // 保存组态图
    $("#cfgSave").on("click", function (ev) {
        var htmls = [];
        htmls.push('<div class="save-form-cfg">');
        htmls.push(createEle('编码', 'code'));
        htmls.push(createEle('名称', 'name'));
        htmls.push('</div>');

        layer.open({
            type: 1,
            title: '组态图保存为: ',
            area: ['460px', '300px'],
            content: htmls.join(""),
            btn: ['确定', '取消'],
            btn1: function (index, layero) {
                //按钮【按钮一】的回调
                var data = DataBind.collectData(layero.find(".save-form-cfg")) || {};
                if (data["code"] == null || data["code"] == ''
                    || data["name"] == null || data["name"] == '') {
                    alert("编码名称不能为空");
                    return true;
                }

                var _master = $.extend({
                    "height": canvas.getHeight(),
                    "width": canvas.getWidth(),
                    "flag": "I"
                }, cfg, data);

                var items = canvas.getObjects();
                var _records = [];
                debugger;
                $.each(items, function (i, item) {
                    _records.push({
                        "id": item.uid,
                        "name": item.name,
                        "posx": item.left,
                        "posy": item.top,
                        "type": item.type,
                        "unit": item.unit,
                        "lower": item.lower,
                        "lowercolor": item.lowercolor,
                        "upper": item.upper,
                        "uppercolor": item.uppercolor,
                        "flag": item.flag,
                        "value": item.value,
                        "font":item.font,
                        "textcolor": item["textcolor"] || '',
                        "prop":item["prop"]
                    });

                });
                var body = {
                    master: _master,
                    details: [
                        {id: "ITEM", extend: "", records: _records}
                    ]
                };


                if (!!cfg.id) {
                    HTTP.post("configure/configure/update", body, function (result) {
                        console.log(result);
                        if (result.success) {
                            layer.alert('保存成功');
                            layer.close(index)
                        } else {
                            layer.alert(result.message || "保存失败");
                        }
                    });
                } else {

                    HTTP.post("configure/configure/add", body, function (result) {
                        console.log(result);
                        if (result.success) {
                            layer.alert('保存成功');
                            layer.close(index)
                        } else {
                            layer.alert(result.message || "保存失败");
                        }
                    });
                }
            },

            btn2: function (index, layero) {
                if (confirm('确定要关闭么')) {
                    layer.close(index)
                }
                return false;
            },

            success: function (layero, index) {
                $(layero).find("input[name='code']").val(cfg.code);
                $(layero).find("input[name='name']").val(cfg.name);
            }
        });

    });

    // 导出为功能
    $("#cfgExport").on("click", function (ev) {
        HTTP.post("configure/configure/buildmenu", cfg, function (result) {
            if (result && result.success) {
                alert(result["message"] || "发布成功.");
            } else {
                alert(result["message"] || "发布失败.");
            }
        })
    });

    function createSeq(init) {
        var _seq = {
            init: parseInt(init) || 0,
            next: function () {
                this.init++;
                return this.init;
            }
        };
        return _seq;
    }

    var nameSeq = createSeq(0);
    var idSeq = createSeq(0);


    $(function () {

        var columns = [
            {"title": "ID", "index": 0, "field": "name", "align": "center", hidden: true},
            {"title": "名称", "index": 6, "field": "title", "width": '50%', "align": "center"},
            {"title": "值", "index": 7, "field": "value", "width": '50%', "align": "center", editor: {type: 'textbox'}}
        ];

        $attrTable.edatagrid({
            pagination: false,
            columns: [columns],
            height: 216,
            showHeader: false,
            autoSave: true,
            onAfterEdit: function (index, row, changes) {
                var klassObj = row.data;
                canvas.remove(klassObj);
                klassObj[row.name] = row.value;
                var path=getrows($attrTable);
                klassObj.set({
                    text: klassObj.val + " " + klassObj.unit,
                    left:Number(path['left']), top:Number(path['top']),fill:path['textcolor'],
                  /*  stroke:path['textcolor'],*/
                    fontSize:parseInt(path["fontSize"]||12),font:parseInt(path["fontSize"]||12),
                });
                canvas.add(klassObj);
                canvas.renderAll();
                if(row.name=="name"&&$pointList.datalist('getSelected')!=null){
                    $pointList.datalist('updateRow',{
                        index: $pointList.datalist('getRowIndex',$pointList.datalist('getSelected')),
                        row:{text: row.value}
                    })
                }

            }
        });
        function getrows($datagrid) {
            var rows=$datagrid.edatagrid('getRows');
            var arry={};
            $.each(rows,function (i,row) {
                arry[row['name']]=row['value']
            });
            return arry;
        }

        $pointList.datalist({
            idField: 'value',
            lines: true,
            onClickRow: function (index, row) {
                var items = canvas.getObjects();
                $.each(items, function (i, item) {
                    if ( item.id === row.value ) {
                        canvas.setActiveObject(item);
                        canvas.renderAll();
                        return false;
                    }
                })

            }
        });

        $("#configure").height($("#attrs").height() - 40);
    });


    canvas.on('object:moving', function (options) {
        options.target.set({left: Math.floor(options.target.left), top: Math.floor(options.target.top)});

        if(options.target.type==="image"){
            $attrTable.edatagrid("loadData", buildAttrsPicture(options.target));
        }else{
            $attrTable.edatagrid("loadData", buildAttrs(options.target));
        }


    });


    // 拖动添加数据点
    canvas.on('drop', function (options) {
        console.log(options);
       layer.msg('选择元素类型', {
            time: 200000, //20s后自动关闭,
            btn: ['点数据', '文本','图形']
            ,yes: function(){
                layer.closeAll();
                var htmls = [];
                htmls.push('<div class="item-cfg">');
                htmls.push(createEle('名称', 'name'));
                htmls.push(createEle('设备', 'device'));
                htmls.push(createEle('数据点', 'value'));
                htmls.push(createEle('单位', 'unit'));
                htmls.push("<input type='hidden' name='type' >");
                htmls.push("<input type='hidden' name='value' >");
                htmls.push('</div>');

                layer.open({
                    type: 1,
                    title: '添加数据点: ',
                    area: ['390px', '410px'],
                    content: htmls.join(""),
                    btn: ['确定', '取消'],
                    btn1: function (index, layero) {
                        //按钮【按钮一】的回调
                        layer.close(index);
                        var data = DataBind.collectData(layero.find(".item-cfg")) || {};
                        var id = idSeq.next();
                        var textData = {
                            id: id,
                            left: Math.floor(options.e.offsetX - 12), top: Math.floor(options.e.offsetY - 12),
                            name: data["name"],
                            type: data["type"] || "RANDOM",
                            unit: data["unit"],
                            fontSize: data["fontSize"]||14,
                            fill: 'red',
                            // stroke: 'red',
                            value: data["value"] || '',
                            val: Math.random().toFixed(2),
                            font: data["fontSize"]||14,
                            textcolor: 'red',
                            flag: "I",

                            hasRotatingPoint: false
                        };


                        if (textData["name"] == null || textData["name"] == '') {
                            textData["name"] = "point_" + nameSeq.next();
                        }


                        var text = new fabric.Text(textData.val + " " + textData.unit, textData);
                        canvas.add(text);


                        text.on('selected', function () {
                            var target = this;
                            target.set({left: Math.floor(target.left), top: Math.floor(target.top)});
                            $attrTable.edatagrid("loadData", buildAttrs(target));
                            $pointList.datalist("unselectAll");
                            $pointList.datalist("selectRecord", target.id);
                        });
                        var pointDatas = $pointList.datalist("getData") || {rows: [], total: 0};
                        pointDatas.rows.push({text: textData.name, value: id});
                        $pointList.datalist("loadData", pointDatas.rows);

                        $pointList.datalist("unselectAll");
                        $pointList.datalist("selectRecord", id);
                        canvas.setActiveObject(text);

                    },

                    btn2: function (index, layero) {
                        return true;
                    },

                    success: function (layero, index) {
                        console.log(layero, index);

                        Appent.choose({
                            title:"数据点",
                            columns: [
                                {title: "指标", field: "metric", fieldType:"ftString", width: 200, hidden:false},
                                {title: "名称", field: "name", fieldType:"ftString", width: 200, hidden:false},
                                {title: "单位", field: "unit", fieldType:"ftString", width: 140, hidden:false},
                                {title: "所属采集区", field: "aeraid", fieldType:"ftString", width: 160, hidden:true},
                                {title: "所属采集区", field: "areaname", fieldType:"ftString", width: 160, hidden:false},
                                {title: "备注", field: "bz", fieldType:"ftString", width: 300, hidden:false}
                            ],
                            url: "metric/metrics/query",parmas:{}
                        }, function (row) {

                            console.log(row);

                            if(row){
                                row["type"] = 'RT';
                                row["value"] = row["metric"];
                                row["device"] = row["areaname"]||"";
                                DataBind.fillIn(layero.find(".item-cfg"), row);
                            }
                        });
                    }
                });

            }
            ,btn2: function(){
                var htmls = [];
                htmls.push('<div class="text-cfg">');
                htmls.push(createEle('名称', 'name'));
                htmls.push(createEle('文本', 'value'));
                htmls.push("<input type='hidden' name='unit' >");
                htmls.push("<input type='hidden' name='device' >");
                htmls.push("<input type='hidden' name='type' >");
                htmls.push('</div>');

                layer.open({
                    type: 1,
                    title: '添加文本: ',
                    area: ['390px', '310px'],
                    content: htmls.join(""),
                    btn: ['确定', '取消'],
                    btn1: function (index, layero) {
                        //按钮【按钮一】的回调
                        layer.close(index);
                        var data = DataBind.collectData(layero.find(".text-cfg")) || {};
                        var id = idSeq.next();
                        var textData = {
                            id: id,
                            left: Math.floor(options.e.offsetX - 12), top: Math.floor(options.e.offsetY - 12),
                            name: data["name"],
                            type: "TEXT",
                            unit: data["unit"],
                            fontSize: data["fontSize"]||14,
                            fill: 'red',
                           /* stroke: 'red',*/
                            value: data["value"] || '',
                            val: data["value"] || '',
                            font: data["fontSize"]||14,
                            textcolor: 'red',
                            flag: "I",
                            fontWeight:100,
                         /*   fontFamily:'Microsoft yahei light'*/
                        };


                        if (textData["name"] == null || textData["name"] == '') {
                            textData["name"] = "point_" + nameSeq.next();
                        }


                        var text = new fabric.Text(textData.val + " " + textData.unit,textData);
                        canvas.add(text);
                        text.on('selected', function () {
                            var target = this;
                            target.set({left: Math.floor(target.left), top: Math.floor(target.top)});
                            $attrTable.edatagrid("loadData", buildAttrs(target));
                            $pointList.datalist("unselectAll");
                            $pointList.datalist("selectRecord", target.id);
                        });
                        var pointDatas = $pointList.datalist("getData") || {rows: [], total: 0};
                        pointDatas.rows.push({text: textData.name, value: id});
                        $pointList.datalist("loadData", pointDatas.rows);

                        $pointList.datalist("unselectAll");
                        $pointList.datalist("selectRecord", id);
                        canvas.setActiveObject(text);

                    },

                    btn2: function (index, layero) {
                        return true;
                    }
                });
            }
            ,btn3:function () {
               layer.closeAll();
               var htmls = [];
               htmls.push('<div class="form-cfg">');
               htmls.push(createEle('名称', 'name'));
               htmls.push(createEle('数据点', 'value'));
               htmls.push(createPictureEle('开', '1','css/icons/dot.png'));
               htmls.push(createPictureEle('关', '0','css/icons/dot1.png'));
               htmls.push("<input type='hidden' name='device' >");
               htmls.push("<input type='hidden' name='type' >");
               htmls.push('</div>');
               layer.open({
                   type: 1,
                   title: '添加开关',
                   area: ['390px', '410px'],
                   content: htmls.join(""),
                   btn: ['确定', '取消'],
                   btn1: function (index, layero) {
                       //按钮【按钮一】的回调

                       var data = DataBind.collectData(layero.find(".form-cfg")) || {};
                       var n1=true,n2=true;
                       if(data["1"]&&data['1'].indexOf('-')>-1){
                           var length=data["1"].split('-').length;
                           if(length!==2){
                               n2=false;
                           }
                       }
                       if(data["0"]&&data['0'].indexOf('-')>-1){
                           var length=data["0"].split('-').length;
                           if(length!==2){
                               n1=false;
                           }
                       }

                       if(!(n1&&n2)){
                           layer.msg('请输入正确的数值或范围');
                           return false
                       }
                       layer.close(index);
                       var props={
                           "on" :data["1"],
                           "off":data["0"]
                       };
                       var url="css/icons/dot.png"
                       var id = idSeq.next();
                       var textData = {
                           id: id,
                           left: Math.floor(options.e.offsetX - 12), top: Math.floor(options.e.offsetY - 12),
                           name: data["name"],
                           value: data.button|| '',
                           val: data.button || '',
                           flag: "I",
                           prop:JSON.stringify(props)
                       };
                       if (textData["name"] == null || textData["name"] == '') {
                           textData["name"] = "point_" + nameSeq.next();
                       }

                        fabric.Image.fromURL(url,function (text){
                           canvas.add(text);
                            text.on('selected', function () {
                                var target = this;
                                target.set({left: Math.floor(target.left), top: Math.floor(target.top)});
                                $attrTable.edatagrid("loadData", buildAttrsPicture(target));
                                $pointList.datalist("unselectAll");
                                $pointList.datalist("selectRecord", target.id);
                            });
                            var pointDatas = $pointList.datalist("getData") || {rows: [], total: 0};
                            pointDatas.rows.push({text: textData.name, value: id});
                            $pointList.datalist("loadData", pointDatas.rows);

                            $pointList.datalist("unselectAll");
                            $pointList.datalist("selectRecord", id);
                            canvas.setActiveObject(text);
                       },textData);


                   },

                   btn2: function (index, layero) {
                       return true;
                   },
                   success:function (layero,index) {
                       Appent.choose({
                           title:"数据点",
                           columns: [
                               {title: "名称",  index: 1, field: "name", width: 160,hidden:false},
                               {title: "数据点ID",  index: 2, field: "tagid", width: 160,hidden:false},
                               {title: "数据采集机器",  index: 3, field: "source", width: 160,hidden:false},
                               {title: "数据来源(设备)",  index: 4, field: "device", width: 160,hidden:false},
                               {title: "类型",  index: 5, field: "type", width: 160,hidden:false},
                               {title: "单位",  index: 6, field: "unit", width: 160,hidden:false},
                               {title: "单位名称",  index: 7, field: "unitname", width: 160,hidden:false},
                               {title: "备注",  index: 8, field: "bz", width: 160,hidden:false},
                           ],
                           url: "rt/tag/query",parmas:{}
                       }, function (row) {

                           console.log(row);

                           if(row){
                               row["type"] = 'RT';
                               row["value"] = row["tagid"];
                               DataBind.fillIn(layero.find(".form-cfg"), row);
                           }
                       });
                       var select = $(layero).find("select[name='button']");
                       select.empty();
                       var record=[{name:"开",code:'1'},{name:'关',code:'0'}];
                       $.each(record, function (i, record) {
                           var opt = select.append("<option value='" + record.code + "'>" + record.name + "</option>");
                           opt.find("option:last").data("data", record);
                       });
                       select.change(function (event) {
                          var value=$(this).val();
                          if(value==="1"){
                              select2.find('a').removeClass('active');
                              $(select2.find('a')[0]).addClass('active');
                          }else if(value==='0'){
                              select2.find('a').removeClass('active');
                              $(select2.find('a')[1]).addClass('active');
                          }
                       });
                       var select2 = $(layero).find("div[class='picture']");
                       var record2=[{code:'1',url:'css/icons/dot.png'},{code:'0',url:"css/icons/dot1.png"}];
                       $.each(record2, function (i, record) {
                           var opt = select2.append("<a><img src='"+record.url+"' alt=''></a>");
                           opt.find("a:last").data("data", record);
                       });
                       $(select2.find('a')[0]).addClass('active');
                  /*     select2.find('a').each(function () {
                           $(this).click(function () {
                               select2.find('a').removeClass('active');
                               $(this).addClass('active');
                           })
                       })*/
                   }
               });
            }
        });


    });


    canvas.renderAll();

</script>
